# Schema Synchronization Guide

## Overview

The UnrealMCPProxy maintains cached tool definitions in `src/unreal_mcp_proxy/tool_definitions.py` that must match the schemas generated by the UnrealMCPServer backend. This guide covers best practices and common pitfalls for keeping these schemas synchronized.

## Table of Contents

1. [Understanding Schema Generation](#understanding-schema-generation)
2. [Best Practices](#best-practices)
3. [Common Pitfalls](#common-pitfalls)
4. [Testing and Validation](#testing-and-validation)
5. [Update Workflow](#update-workflow)
6. [Troubleshooting](#troubleshooting)

## Understanding Schema Generation

### Backend Schema Generation

The backend generates JSON schemas from C++ USTRUCT definitions using `UMCP_GenerateJsonSchemaFromStruct`. Key behaviors:

1. **Property Names**: Converted to camelCase (e.g., `bRecursive` → `bRecursive`, `timeoutSeconds` → `timeoutSeconds`)
2. **Default Values**: Extracted from default-constructed USTRUCT instances
   - Empty strings are **not** included as defaults
   - Empty arrays **are** included as defaults (`[]`)
   - Numbers, booleans, and objects are included as defaults
3. **Required Fields**: Determined by:
   - Explicit `RequiredFields` parameter in schema generation
   - Or all fields are required if no explicit list is provided
4. **Nested Structs**: Marked as `"type": "object"` without expanding properties
   - Default values for nested objects are included as full JSON objects
5. **Descriptions**: Extracted from:
   - Explicit `PropertyDescriptions` map (preferred)
   - UPROPERTY metadata (`ToolTip` or `Description`)
   - Or omitted if not available

### Proxy Schema Format

The proxy's cached schemas must match the backend's generated schemas exactly, including:
- Property names (camelCase)
- Types (string, number, boolean, array, object)
- Default values (when present)
- Required fields
- Descriptions (when present)
- Enum values (for string enums)

## Best Practices

### 1. Always Use the Test Suite

**Before committing schema changes:**
```bash
cd UnrealMCPProxy
uv --directory . run test_proxy.py
```

The test suite will:
- Query the backend for actual schemas
- Compare with cached definitions
- Show detailed differences for any mismatches
- Report missing or extra tools

**Never skip this step** - it's the only reliable way to detect mismatches.

### 2. Update Both Sides Together

When modifying backend tool definitions:
1. Update the C++ USTRUCT definitions
2. Update the proxy's `tool_definitions.py` immediately
3. Run the test suite to verify
4. Commit both changes together

### 3. Use Detailed Comparison Output

When the test suite reports mismatches, it shows:
- Full JSON schemas for cached vs backend
- Exact property differences
- Missing or extra fields

Use this output to make precise fixes rather than guessing.

### 4. Understand Default Value Rules

**Backend includes defaults for:**
- Empty arrays: `"default": []`
- Numbers with explicit defaults: `"default": 0`, `"default": 300`
- Booleans with explicit defaults: `"default": false`, `"default": true`
- Nested objects with non-empty defaults: `"default": {...}`

**Backend excludes defaults for:**
- Empty strings (not meaningful defaults)
- Non-empty arrays (too complex)

### 5. Match Required Fields Exactly

Required fields must match exactly:
- If backend has `"required": []` for empty schemas, proxy should omit it
- If backend has `"required": ["field1", "field2"]`, proxy must match exactly
- Order doesn't matter (comparison uses sorted keys)

### 6. Handle Nested Objects Correctly

For nested structs in output schemas:
- Type: `"type": "object"` (not expanded)
- Include default if backend includes it: `"default": {...}`
- Don't expand nested properties in the schema

Example:
```python
"engineVersion": {
    "type": "object",
    "description": "Engine version information",
    "default": {
        "changelist": 0,
        "full": "",
        "major": 0,
        "minor": 0,
        "patch": 0
    }
}
```

### 7. Preserve Field Order (Optional but Helpful)

While field order doesn't affect functionality, maintaining a consistent order makes diffs easier to read:
- Input schemas: required fields first, then optional
- Output schemas: success/status fields first, then data fields, then error fields

## Common Pitfalls

### 1. Adding Descriptions That Don't Exist

**Problem**: Adding descriptions to fields that the backend doesn't describe.

**Example**: Backend generates `bRecursive` without a description, but proxy includes one.

**Solution**: Only include descriptions that match the backend. If backend omits a description, proxy must also omit it.

### 2. Wrong Default Value Types

**Problem**: Using `300.0` (float) when backend uses `300` (integer).

**Solution**: Match the exact type. The backend's JSON schema uses `"type": "number"` for both, but the default value must match exactly: `300` not `300.0`.

### 3. Including Empty Required Arrays

**Problem**: Including `"required": []` when backend omits it.

**Solution**: For empty input schemas, omit the `"required"` field entirely if backend omits it.

### 4. Expanding Nested Object Properties

**Problem**: Expanding nested struct properties in the schema instead of marking as `"type": "object"`.

**Solution**: Nested structs should be `"type": "object"` without property expansion. The backend doesn't recursively expand nested structs.

### 5. Missing Array Defaults

**Problem**: Forgetting to add `"default": []` for array fields.

**Solution**: All array fields in output schemas should have `"default": []` if the backend includes it.

### 6. Boolean Defaults in Output Schemas

**Problem**: Forgetting `"default": false` for boolean fields in output schemas.

**Solution**: Most boolean fields in output schemas (like `bSuccess`, `bCompileStarted`) should have `"default": false` if the backend includes it.

### 7. Numeric Defaults

**Problem**: Forgetting `"default": 0` for numeric fields with explicit defaults.

**Solution**: Check the backend USTRUCT for fields like `int32 count = 0` and include `"default": 0` in the schema.

### 8. Required Field Mismatches

**Problem**: Backend marks all fields as required, but proxy only marks some.

**Solution**: Check the backend's schema generation code to see if it uses explicit `RequiredFields` or defaults to all fields required.

### 9. Field Name Case Sensitivity

**Problem**: Using `recursive` instead of `bRecursive` (or vice versa).

**Solution**: Match the exact field name from the backend USTRUCT. The backend converts to camelCase, so `bRecursive` stays `bRecursive`.

### 10. Conditional Features

**Problem**: Not updating tool definitions when conditional features change.

**Solution**: When markdown export support is enabled/disabled, ensure tool descriptions match. Use the `enable_markdown_export` parameter in `get_tool_definitions()`.

## Testing and Validation

### Running the Test Suite

```bash
cd UnrealMCPProxy
uv --directory . run test_proxy.py
```

**Expected Output:**
- ✓ All 15 tools defined
- ✓ Backend connection successful
- ✓ Schema comparison: 15 matches, 0 mismatches

### Interpreting Test Results

**All Matches:**
```
✓ Matches: 15
✗ Mismatches: 0
```
✅ Safe to commit

**Mismatches Detected:**
```
✗ Mismatches: 5
```
❌ Fix mismatches before committing. The test will show detailed differences for the first 3 mismatches.

**Missing Tools:**
```
⚠ Missing in cache: 2
```
❌ New tools added to backend but not yet in proxy. Add them to `tool_definitions.py`.

**Extra Tools:**
```
⚠ Missing in backend: 1
```
⚠️ Tool removed from backend but still in cache. Remove it from `tool_definitions.py` or verify it's intentionally deprecated.

### Debugging Mismatches

When a mismatch is detected, the test shows:
1. Tool name
2. Type of mismatch (InputSchema, OutputSchema, or both)
3. Full JSON comparison (cached vs backend)

Use this to identify:
- Missing or extra properties
- Wrong types
- Missing defaults
- Wrong required fields
- Description mismatches

## Update Workflow

### When Backend Changes

1. **Identify the Change**
   - What USTRUCT was modified?
   - What properties changed?
   - Are there new defaults?
   - Are required fields different?

2. **Update Proxy Schema**
   - Edit `src/unreal_mcp_proxy/tool_definitions.py`
   - Match the backend schema exactly
   - Include all defaults, required fields, descriptions

3. **Test Immediately**
   ```bash
   uv --directory . run test_proxy.py
   ```

4. **Verify No Warnings**
   - Start the proxy
   - Check logs for mismatch warnings
   - Should see: "15 tools found, 0 mismatches detected"

5. **Commit Together**
   - Commit backend changes and proxy changes in the same PR
   - Include test results in commit message

### When Adding New Tools

1. **Backend First**
   - Add USTRUCT definitions
   - Register tool in backend
   - Verify backend generates correct schema

2. **Add to Proxy**
   - Add tool definition to `tool_definitions.py`
   - Use test suite output to get exact schema
   - Or copy from backend's `tools/list` response

3. **Test**
   - Run test suite
   - Verify new tool appears in both backend and cache
   - Verify no mismatches

### When Removing Tools

1. **Backend First**
   - Remove tool registration
   - Remove USTRUCT definitions (if unused)

2. **Remove from Proxy**
   - Remove from `tool_definitions.py`
   - Update expected tool count in tests

3. **Test**
   - Run test suite
   - Verify tool no longer appears
   - Verify no "missing in backend" warnings

## Troubleshooting

### "Mismatch detected but schemas look identical"

**Possible Causes:**
- Whitespace differences (unlikely with JSON comparison)
- Property order differences (shouldn't matter, but verify)
- Type differences (`300` vs `300.0`)
- Missing or extra commas in JSON

**Solution:** Use the detailed comparison output. Look for exact differences in the JSON strings.

### "Backend schema missing description"

**Possible Causes:**
- Description not provided in backend's `PropertyDescriptions` map
- UPROPERTY metadata missing
- Field name mismatch in description map

**Solution:** Remove description from proxy schema to match backend. If description is needed, add it to backend first.

### "Default value mismatch"

**Possible Causes:**
- Wrong type (`300` vs `300.0`)
- Missing default in backend USTRUCT
- Backend filters out the default (e.g., empty string)

**Solution:** Check the backend's `UMCP_ExtractDefaultValueFromJson` logic. Match the exact default value type and format.

### "Required fields don't match"

**Possible Causes:**
- Backend uses explicit `RequiredFields` list
- Backend defaults to all fields required
- Proxy has wrong required list

**Solution:** Check backend's schema generation call. See if it provides `RequiredFields` or uses default behavior.

### "Nested object mismatch"

**Possible Causes:**
- Proxy expanded nested properties
- Missing default object
- Wrong object structure

**Solution:** Nested structs should be `"type": "object"` only. Include default if backend includes it.

## Quick Reference Checklist

Before committing schema changes:

- [ ] Run test suite: `uv --directory . run test_proxy.py`
- [ ] All 15 tools match (or expected count)
- [ ] 0 mismatches detected
- [ ] No missing tools warnings
- [ ] No extra tools warnings
- [ ] Proxy starts without mismatch warnings
- [ ] Backend and proxy changes committed together
- [ ] Test results included in commit message

## Related Documentation

- `PROXY_IMPLEMENTATION_PLAN.md` - Overall proxy architecture
- `README.md` - Proxy setup and usage
- `test_proxy.py` - Test suite implementation
- Backend: `Source/UnrealMCPServer/Public/UMCP_Types.h` - Schema generation logic

## Summary

Keeping schemas synchronized requires:
1. **Understanding** how the backend generates schemas
2. **Testing** regularly with the automated test suite
3. **Matching** schemas exactly (types, defaults, required fields, descriptions)
4. **Updating** both sides together when making changes
5. **Verifying** no warnings on startup

The test suite is your best friend - use it liberally and fix mismatches immediately.

